<div class="voucher-admin">

  <div class="header">
    <h2>Quản lý Voucher</h2>
    <div class="actions">
      <input
        type="text"
        placeholder="Tìm kiếm voucher..."
        [(ngModel)]="search"
        (ngModelChange)="onSearchChange($event)"
      />
      <button class="create-btn" (click)="openCreateForm()">
        + Tạo mới
      </button>
    </div>
  </div>

  <div class="table-wrapper" *ngIf="!loading && vouchers.length > 0">
    <table class="voucher-table">
      <thead>
        <tr>
          <th>Mã</th>
          <th>Loại</th>
          <th>Giá trị</th>
          <th>Đơn tối thiểu</th>
          <th>Bắt đầu</th>
          <th>Kết thúc</th>
          <th>Giới hạn</th>
          <th>Đã dùng</th>
          <th>Thao tác</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let v of vouchers">
          <td>{{ v.code }}</td>
          <td>{{ v.type }}</td>
          <td>{{ v.type === 'percent' ? (v.value + '%') : (v.value | number) }}</td>
          <td>{{ v.min_order_value | number }} đ</td>
          <td>{{ v.start_date | date: 'dd/MM/yyyy' }}</td>
          <td>{{ v.end_date | date: 'dd/MM/yyyy' }}</td>
          <td>{{ v.usage_limit }}</td>
          <td>{{ v.used_count || 0 }}</td>
          <td class="action-col">
            <button class="edit-btn" (click)="openEditForm(v)">Sửa</button>
            <button class="delete-btn" (click)="deleteVoucher(v.code)">Xóa</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="loading" class="loading">Đang tải...</div>
  <div *ngIf="!loading && vouchers.length === 0" class="no-data">
    Không có voucher nào
  </div>

  <div class="pagination" *ngIf="total > limit">
    <button (click)="changePage(page - 1)" [disabled]="page === 1">
      ‹
    </button>
    <span>Trang {{ page }} / {{ totalPages }}</span>
    <button (click)="changePage(page + 1)" [disabled]="page === totalPages">
      ›
    </button>
  </div>

  <!-- MODAL -->
  <div *ngIf="showForm" class="modal-overlay" (click)="cancelForm()">
    <div class="modal" (click)="$event.stopPropagation()">
      <h3>{{ editingVoucherCode ? 'Sửa Voucher' : 'Tạo Voucher' }}</h3>

      <form (ngSubmit)="submitForm()" [formGroup]="form">
        
        <div class="form-group">
          <label>Mã Voucher</label>
          <input type="text" formControlName="code" [readonly]="editingVoucherCode !== null" />
        </div>

        <div class="form-group">
          <label>Giá trị</label>
          <input type="number" formControlName="value" min="0" />
        </div>

        <div class="form-group">
          <label>Loại</label>
          <select formControlName="type">
            <option value="percent">Phần trăm (%)</option>
            <option value="fixed">Số tiền cố định</option>
          </select>
        </div>

        <div class="form-group">
          <label>Đơn tối thiểu (đ)</label>
          <input type="number" formControlName="min_order_value" />
        </div>

        <div class="form-group">
          <label>Ngày bắt đầu</label>
          <input type="date" formControlName="start_date" />
        </div>

        <div class="form-group">
          <label>Ngày kết thúc</label>
          <input type="date" formControlName="end_date" />
        </div>

        <div class="form-group">
          <label>Giới hạn lượt dùng</label>
          <input type="number" formControlName="usage_limit" />
        </div>

        <div *ngIf="errorMsg" class="error">{{ errorMsg }}</div>

        <div class="modal-actions">
          <button class="save-btn" type="submit">
            {{ editingVoucherCode ? 'Cập nhật' : 'Tạo mới' }}
          </button>

          <button class="cancel-btn" type="button" (click)="cancelForm()">
            Hủy
          </button>
        </div>

      </form>
    </div>
  </div>

</div>
