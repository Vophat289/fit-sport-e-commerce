<div class="variant-admin">
  <div class="page-header">
    <div>
      <p class="sub-title">Sản phẩm</p>
      <h2 class="page-title">Quản lý Biến thể: {{ productName }}</h2>
    </div>

    <div class="header-actions">
      <button class="btn ghost" (click)="goBackToProducts()">
        <i class="bx bx-arrow-back"></i> Quay lại
      </button>
    </div>
  </div>

  <div
    class="alert"
    *ngIf="message"
    [class.success]="message.type === 'success'"
    [class.error]="message.type === 'error'"
  >
    <i
      class="bx"
      [class.bx-check-circle]="message!.type === 'success'"
      [class.bx-error-circle]="message!.type === 'error'"
    ></i>
    <span>{{ message!.text }}</span>
  </div>

  <div class="loading" *ngIf="isLoading && variants.length === 0">
    <i class="bx bx-loader bx-spin"></i>
    <span>Đang tải biến thể...</span>
  </div>

  <div class="card form-variant">
    <h3>{{ isEditMode ? "Chỉnh sửa biến thể" : "Thêm biến thể mới" }}</h3>
    <form
      [formGroup]="variantForm"
      (ngSubmit)="submitVariant()"
      class="form-grid"
    >
      <label>
        Size <span class="required"></span>
        <select formControlName="size_id">
          <option value="">-- Chọn Size --</option>
          <option *ngFor="let s of sizes" [value]="s._id">{{ s.name }}</option>
        </select>
        <small
          *ngIf="
            variantForm.get('size_id')?.invalid &&
            variantForm.get('size_id')?.touched
          "
          class="error"
        >
          Vui lòng chọn size
        </small>
      </label>

      <label>
        Màu sắc <span class="required"></span>
        <select formControlName="color_id">
          <option value="">-- Chọn Màu --</option>
          <option *ngFor="let c of colors" [value]="c._id">{{ c.name }}</option>
        </select>
        <small
          *ngIf="
            variantForm.get('color_id')?.invalid &&
            variantForm.get('color_id')?.touched
          "
          class="error"
        >
          Vui lòng chọn màu
        </small>
      </label>

      <label>
        Giá (đ) <span class="required"></span>
        <input type="number" formControlName="price" min="1" />
        <small
          *ngIf="variantForm.get('price')?.errors?.['required'] && variantForm.get('price')?.touched"
          class="error"
        >
          Giá không được để trống
        </small>
        <small
          *ngIf="variantForm.get('price')?.errors?.['min'] && variantForm.get('price')?.touched"
          class="error"
        >
          Giá phải lớn hơn 0
        </small>
      </label>

      <label>
        Số lượng <span class="required"></span>
        <input type="number" formControlName="quantity" min="0" />
        <small
          *ngIf="variantForm.get('quantity')?.errors?.['required'] && variantForm.get('quantity')?.touched"
          class="error"
        >
          Số lượng không được để trống
        </small>
        <small
          *ngIf="variantForm.get('quantity')?.errors?.['min'] && variantForm.get('quantity')?.touched"
          class="error"
        >
          Số lượng không được âm
        </small>
      </label>

      <div class="form-actions">
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="variantForm.invalid || isLoading"
        >
          <i class="bx bx-loader-alt bx-spin" *ngIf="isLoading"></i>
          {{ isEditMode ? "Cập nhật" : "Thêm mới" }}
        </button>
        <button type="button" class="btn ghost" (click)="resetForm()">
          {{ isEditMode ? "Hủy sửa" : "Reset" }}
        </button>
      </div>
    </form>
  </div>

  <hr />

 <div class="card table-container">
    <h3>Danh sách Biến thể đã tạo ({{ variants.length }})</h3>
    <table>
      <tbody>
        <tr *ngIf="variants.length === 0">
          <td colspan="6" class="empty">Chưa có biến thể nào được tạo.</td>
        </tr>
        <tr *ngFor="let variant of variants; let i = index">
          <td>{{ i + 1 }}</td>

          <td>
            {{ getSizeDisplay(variant) }}
          </td>

          <td>
            <span
              class="color-box"
              [style.background-color]="getColorDisplay(variant, 'code')"
              
              [title]="getColorDisplay(variant, 'name')"
            >
            </span>
          </td>

          <td>{{ variant.price | number : "1.0-0" }}đ</td>
          <td>{{ variant.quantity }}</td>
          <td class="actions">
            <button
              class="btn icon"
              (click)="editVariant(variant)"
              title="Chỉnh sửa"
            >
              <i class="bx bx-edit-alt"></i>
            </button>
            <button
              class="btn icon danger"
              (click)="deleteVariant(variant._id!)"
              title="Xóa"
            >
              <i class="bx bx-trash"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

  
    <div class="add-option-box">
      <div class="add-size">
        <h4>Thêm Size mới</h4>
        <div class="input-group">
          <input type="text" [(ngModel)]="newSize" name="newSize" placeholder="Nhập size">
          <button (click)="createSize()">Thêm Size</button>
        </div>
      </div>

      <div class="add-color">
        <h4>Thêm Màu mới</h4>
        <div class="input-group">
            <input type="text" [(ngModel)]="newColor" name="newColor" placeholder="Tên màu">
            <input type="color" [(ngModel)]="newColorHex" name="newColorHex">
          <button (click)="createColor()">Thêm Màu</button>
        </div>
      </div>
    </div>