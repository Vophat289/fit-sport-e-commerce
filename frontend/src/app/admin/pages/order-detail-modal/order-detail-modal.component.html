<div class="modal-overlay" (click)="closeModal()">
  <div class="modal" (click)="stopPropagation($event)">
    <!-- Modal Header -->
    <div class="modal-header">
      <div>
        <p class="sub-title">Chi tiết đơn hàng</p>
        <h3>{{ order.order_code }}</h3>
        <div class="status-badge-container">
          <span class="badge" [ngClass]="getStatusBadgeClass(order.status)">
            {{ getStatusLabel(order.status) }}
          </span>
        </div>
      </div>
      <button class="btn-close" (click)="closeModal()">
        <i class="bx bx-x"></i>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <!-- Error Message -->
      <div class="alert alert-error" *ngIf="errorMsg">
        <i class="bx bx-error-circle"></i>
        <span>{{ errorMsg }}</span>
      </div>

      <!-- Customer Info -->
      <div class="info-section">
        <h4 class="section-title">
          <i class="bx bx-user"></i>
          Thông tin khách hàng
        </h4>
        <div class="info-grid">
          <div class="info-item">
            <label>Tên:</label>
            <span>{{ order.user.name }}</span>
          </div>
          <div class="info-item">
            <label>Email:</label>
            <span>{{ order.user.email }}</span>
          </div>
          <div class="info-item">
            <label>Số điện thoại:</label>
            <span>{{ order.user.phone }}</span>
          </div>
        </div>
      </div>

      <!-- Receiver Info -->
      <div class="info-section">
        <h4 class="section-title">
          <i class="bx bx-map"></i>
          Thông tin người nhận
        </h4>
        <div class="info-grid">
          <div class="info-item">
            <label>Tên người nhận:</label>
            <span>{{ order.receiver.name }}</span>
          </div>
          <div class="info-item">
            <label>Số điện thoại:</label>
            <span>{{ order.receiver.mobile }}</span>
          </div>
          <div class="info-item full-width">
            <label>Địa chỉ:</label>
            <span>{{ order.receiver.address }}</span>
          </div>
        </div>
      </div>

      <!-- Order Items -->
      <div class="info-section">
        <h4 class="section-title">
          <i class="bx bx-package"></i>
          Sản phẩm ({{ order.items.length }})
        </h4>
        <div class="items-table">
          <table>
            <thead>
              <tr>
                <th>Sản phẩm</th>
                <th>Size/Color</th>
                <th>Giá</th>
                <th>SL</th>
                <th>Thành tiền</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of order.items">
                <td>
                  <div class="product-info">
                    <img 
                      [src]="item.variant.image || item.product.image || '/assets/no-image.png'" 
                      [alt]="item.product.name"
                      class="product-image"
                      onerror="this.src='/assets/no-image.png'"
                    />
                    <div>
                      <strong>{{ item.product.name }}</strong>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="variant-info">
                    <span>Size: {{ item.variant.size }}</span>
                    <span>Color: {{ item.variant.color }}</span>
                  </div>
                </td>
                <td>{{ formatCurrency(item.price) }}</td>
                <td>{{ item.quantity }}</td>
                <td><strong>{{ formatCurrency(item.subtotal) }}</strong></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pricing -->
      <div class="info-section">
        <h4 class="section-title">
          <i class="bx bx-calculator"></i>
          Tổng tiền
        </h4>
        <div class="pricing-details">
          <div class="pricing-row">
            <span>Tổng sản phẩm:</span>
            <span>{{ formatCurrency(order.pricing.total_items) }}</span>
          </div>
          <div class="pricing-row">
            <span>Phí giao hàng:</span>
            <span>{{ formatCurrency(order.pricing.delivery_fee) }}</span>
          </div>
          <div class="pricing-row" *ngIf="order.voucher">
            <span>Voucher ({{ order.voucher.code }}):</span>
            <span class="discount">-{{ formatCurrency(order.pricing.voucher_discount) }}</span>
          </div>
          <div class="pricing-row total">
            <span>Tổng cộng:</span>
            <span><strong>{{ formatCurrency(order.pricing.final_amount) }}</strong></span>
          </div>
        </div>
      </div>

      <!-- Payment Info -->
      <div class="info-section">
        <h4 class="section-title">
          <i class="bx bx-credit-card"></i>
          Thông tin thanh toán
        </h4>
        <div class="info-grid">
          <div class="info-item">
            <label>Phương thức:</label>
            <span>{{ order.payment_method }}</span>
          </div>
          <div class="info-item">
            <label>Trạng thái:</label>
            <span class="badge" [ngClass]="getPaymentStatusBadgeClass(order.payment_status)">
              {{ order.payment_status }}
            </span>
          </div>
          <div class="info-item" *ngIf="order.vnpay_transaction_id">
            <label>Transaction ID:</label>
            <code>{{ order.vnpay_transaction_id }}</code>
          </div>
        </div>
      </div>

      <!-- Status Update -->
      <div class="info-section">
        <h4 class="section-title">
          <i class="bx bx-edit"></i>
          Thay đổi trạng thái đơn hàng
        </h4>
        <div class="status-update">
          <select 
            [(ngModel)]="selectedStatus" 
            class="status-select"
            [disabled]="updating">
            <option *ngFor="let opt of statusOptions" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>
          <button 
            class="btn btn-primary" 
            (click)="updateStatus()"
            [disabled]="updating || selectedStatus === order.status">
            <i class="bx bx-loader-alt bx-spin" *ngIf="updating"></i>
            <span *ngIf="!updating">Cập nhật trạng thái</span>
            <span *ngIf="updating">Đang cập nhật...</span>
          </button>
        </div>
      </div>

      <!-- Order Dates -->
      <div class="info-section">
        <div class="info-grid">
          <div class="info-item">
            <label>Ngày tạo:</label>
            <span>{{ formatDate(order.createdAt) }}</span>
          </div>
          <div class="info-item">
            <label>Cập nhật lần cuối:</label>
            <span>{{ formatDate(order.updatedAt) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">
        Đóng
      </button>
    </div>
  </div>
</div>
