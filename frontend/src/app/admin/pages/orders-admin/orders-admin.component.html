<div class="orders-admin">

  <!-- TIÊU ĐỀ + TÌM KIẾM -->
  <div class="page-header">
    <div>
      <p class="sub-title">Đơn hàng</p>
      <h2 class="page-title">Quản lý đơn hàng</h2>
    </div>

    <div class="header-actions">
      <div class="search-box">
        <i class='bx bx-search'></i>
        <input type="text" placeholder="Tìm mã đơn hoặc email khách..." [(ngModel)]="searchText" (input)="onSearch()" />
      </div>
    </div>
  </div>

  <!-- BẢNG ĐƠN HÀNG -->
  <div class="table-wrapper" style="margin-top: 20px;">
    <table class="order-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Mã đơn</th>
          <th>Khách hàng</th>
          <th>Tổng tiền</th>
          <th>Điện thoại</th>
          <th>Ngày đặt</th>
          <th>Trạng thái</th>
          <th>Hành động</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let order of filteredOrders; let i = index">
          <td>{{ i + 1 }}</td>
          <td><strong>{{ order.id }}</strong></td>
          <td>{{ order.customer }}</td>
          <td class="price">{{ order.total | number:'1.0-0' }} VND</td>
          <td>{{ order.phone }}</td>
          <td>{{ order.date }}</td>
          <td>
            <span class="status-badge" [ngClass]="'status-' + order.status">
              {{ mapStatus(order.status) }}
            </span>
          </td>
          <td class="actions">
            <button class="detail-btn" (click)="viewDetails(order)">Xem</button>
          </td>
        </tr>

        <tr *ngIf="filteredOrders.length === 0">
          <td colspan="10" class="empty">Không tìm thấy đơn hàng nào</td>
        </tr>
      </tbody>

    </table>
  </div>

  <!-- MODAL CHI TIẾT -->
  <div class="modal-backdrop" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <span class="close-btn" (click)="closeModal()">×</span>
      <h3>Chi tiết đơn hàng #{{ selectedOrder?.order_code }}</h3>
      <p class="order-date-modal">Ngày đặt: {{ selectedOrder?.createdAt | date:'dd/MM/yyyy HH:mm' }}</p>

      <div class="modal-grid">

        <!-- Sản phẩm -->
        <div class="modal-box products-box">
          <h4> Sản phẩm đã đặt</h4>
          <div class="items">
            <div class="item" *ngFor="let item of selectedOrder?.items">
              <!-- ảnh sản phẩm-->
              <img
                [src]="item.image && item.image.length ? item.image[0] : placeholderImage"
                [alt]="item.productName"
                (error)="onImageError($event)"
              />

              <p class="item-name">{{ item.productName || 'Sản phẩm' }}</p>
              <p class="item-info">SL: <strong>{{ item.quantity || 1 }}</strong></p>
              <p class="item-info">Giá:
                <strong class="price">
                  {{ item.price ? (item.price | number:'1.0-0') : 0 }} VND
                </strong>
              </p>
            </div>
          </div>
        </div>

        <!-- USER INFO -->
        <div class="modal-box">
          <h4> Thông tin người nhận</h4>

          <div class="info-group">
            <p><strong>Tên người nhận:</strong></p>
            <p>{{ selectedOrder?.customer }}</p>
          </div>

          <div class="info-group">
            <p><strong>Điện thoại:</strong></p>
            <p>{{ selectedOrder?.phone }}</p>
          </div>

          <div class="info-group">
            <p><strong>Email người đặt:</strong></p>
            <p>{{ selectedOrder?.user_id?.email || '—' }}</p>
          </div>
        </div>

        <!-- ĐỊA CHỈ + THANH TOÁN (ĐÃ ĐƯA VÀO MODAL) -->
        <div class="modal-box">
          <h4> Địa chỉ & Thanh toán</h4>

          <p class="full-address">
            {{ selectedOrder?.receiver_address || '—' }}
          </p>

          <hr>

          <div class="info-group total-price-modal">
            <p><strong> Tổng thanh toán:</strong></p>
            <p class="price">
              {{ selectedOrder?.total_price ? (selectedOrder.total_price | number:'1.0-0') : 0 }} VND
            </p>
          </div>

          <div class="info-group">
            <p><strong>Tình trạng :</strong></p>
            <p>
              <span class="pay-status" [class.paid]="selectedOrder?.payment_status === 'PAID'">
                {{ selectedOrder?.payment_status === 'PAID' ? 'Đã thanh toán' : 'Chưa thanh toán' }}
              </span>
            </p>
          </div>
        </div>

        <!-- Cập nhật trạng thái -->
        <div class="modal-box status-box">
          <h4> Cập nhật Trạng thái</h4>

          <div class="info-group">
            <p><strong>Trạng thái hiện tại:</strong></p>
            <span class="status-badge" [ngClass]="'status-' + selectedOrder?.status">
              {{ mapStatus(selectedOrder?.status || 'PENDING') }}
            </span>
          </div>

          <div class="status-selector">
            <label for="status-select">Chọn trạng thái mới:</label>

            <select id="status-select" [(ngModel)]="selectedOrder.status">
              <option *ngFor="let status of STATUS_OPTIONS" [value]="status.value">
                {{ status.label }}
              </option>
            </select>

            <button class="update-btn" (click)="updateStatusFromModal()">
              Cập nhật 
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

</div>
