<div class="product-detail-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Đang tải sản phẩm...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <p>{{ error }}</p>
    <button class="btn-outline" (click)="router.navigate(['/products'])">
      Quay về trang sản phẩm
    </button>
  </div>

  <!-- Product Detail Content -->
  <div *ngIf="product && !loading" class="product-detail-content">
    <!-- Breadcrumb (Đường dẫn) -->
    <nav class="breadcrumb">
      <a routerLink="/home">Trang chủ</a>
      <span>/</span>
      <a routerLink="/products">Sản phẩm</a>
      <span>/</span>
      <span>{{ product.name }}</span>
    </nav>

    <!-- Main Content: 2 Cột -->
    <section class="product-main">
      <!-- Cột trái: Ảnh sản phẩm -->
      <div class="product-images">
        <!-- Ảnh lớn (hiển thị ảnh đang chọn) -->
        <div class="main-image">
          <img
            [src]="
              product.image && product.image[selectedImageIndex]
                ? product.image[selectedImageIndex]
                : 'assets/images/placeholder.jpg'
            "
            [alt]="product.name"
            class="main-img"
          />
        </div>

        <!-- Gallery: Danh sách ảnh nhỏ -->
        <div
          *ngIf="product.image && product.image.length > 1"
          class="image-gallery"
        >
          <div
            *ngFor="let img of product.image; let i = index"
            class="gallery-thumb"
            [class.active]="i === selectedImageIndex"
            (click)="selectImage(i)"
          >
            <img [src]="img" [alt]="product.name + ' - Ảnh ' + (i + 1)" />
          </div>
        </div>
      </div>

      <!-- Cột phải: Thông tin sản phẩm -->
      <div class="product-info">
        <!-- Tên sản phẩm -->
        <h1 class="product-title">{{ product.name }}</h1>
        <p class="text-sm text-gray-600">
          Tồn kho:
          <span class="font-semibold">
            {{ currentVariantDetails?.quantity || 0 }}
          </span>
        </p>

        <!-- Giá -->
        <div class="product-price-section">
          <div>
            <span class="price">{{
              currentVariantDetails?.price | currency : "VND"
            }}</span>
            <span class="price-tag">Giá tốt nhất hôm nay</span>
          </div>
        </div>

        <!-- Lượt xem -->
        <div class="product-meta">
          <span class="meta-badge">
            <i class="fa-solid fa-eye"></i>
            {{ product.viewCount ?? 0 }} lượt xem
          </span>
          <span class="meta-badge">
            <i class="fa-solid fa-shield"></i>
            Chính hãng 100%
          </span>
          <span class="meta-badge">
            <i class="fa-solid fa-truck-fast"></i>
            Giao nhanh 2h
          </span>
        </div>

        <!-- Mô tả ngắn -->
        <!-- <div class="product-description">
            <p>{{ product.description }}</p>
          </div> -->

        <!-- Chọn màu sắc -->
        <div
          *ngIf="product.availableColors && product.availableColors.length > 0"
          class="product-options"
        >
          <h3 class="option-title">Màu sắc:</h3>
          <div class="color-options">
            <div
              *ngFor="let color of product.availableColors"
              class="color-option"
              [class.selected]="selectedColor === color.id"
              (click)="selectColor(color.id); updateVariantDetails()"
              [style.backgroundColor]="color.hex_code"
              [title]="color.name"
            ></div>
          </div>
        </div>

        <!-- Chọn kích thước -->
        <div
          *ngIf="product.availableSizes && product.availableSizes.length > 0"
          class="product-options"
        >
          <h3 class="option-title">Kích thước:</h3>
          <div class="size-options">
            <button
              *ngFor="let size of product.availableSizes"
              class="size-option"
              [class.selected]="selectedSize === size.id"
              (click)="selectSize(size.id); updateVariantDetails()"
            >
              {{ size.name }}
            </button>
          </div>
        </div>

        <!-- Số lượng (tùy chọn) -->
        <div class="quantity-section">
          <label>Số lượng:</label>
          <div class="quantity-controls">
            <button class="qty-btn" (click)="decreaseQuantity()">−</button>
            <input
              type="number"
              [(ngModel)]="quantity"
              min="1"
              class="qty-input"
            />
            <button class="qty-btn" (click)="increaseQuantity()">+</button>
          </div>
        </div>
        <div *ngIf="stockMessage" style="color: red" class="text-sm mt-1">
          {{ stockMessage }}
        </div>
        <!-- Nút thêm vào giỏ -->
        <div class="action-buttons">
          <button
            class="btn-add-cart"
            (click)="addToCart()"
            [disabled]="
              !currentVariantDetails || currentVariantDetails.quantity === 0
            "
          >
            <i class="fa-solid fa-cart-plus"></i>
            Thêm vào giỏ hàng
          </button>
          <button class="btn-buy-now">
            <i class="fa-solid fa-bolt"></i>
            Mua ngay
          </button>
        </div>

        <!-- Thông tin bổ sung -->
        <div class="service-highlights">
          <div class="meta-item">
            <i class="fa-solid fa-truck"></i>
            <div>
              <h4>Miễn phí ship</h4>
              <p>Cho đơn từ 299.000đ</p>
            </div>
          </div>
          <div class="meta-item">
            <i class="fa-solid fa-rotate-left"></i>
            <div>
              <h4>Đổi trả linh hoạt</h4>
              <p>Trong vòng 7 ngày</p>
            </div>
          </div>
          <div class="meta-item">
            <i class="fa-solid fa-shield-heart"></i>
            <div>
              <h4>Bảo hành chính hãng</h4>
              <p>Cam kết chất lượng</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tab thông tin chi tiết (mô tả, đánh giá, v.v.) -->
<section class="product-tabs">
  <div class="tab-header">
    <button
      class="tab-btn"
      [class.active]="activeTab === 'description'"
      (click)="switchTab('description')"
    >
      Mô tả sản phẩm
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'reviews'"
      (click)="switchTab('reviews')"
    >
      Đánh giá
    </button>
  </div>

  <div class="tab-content">
    <!-- Mô tả sản phẩm -->
    <div *ngIf="activeTab === 'description'">
      
      <p>{{ product.description }}</p>
    </div>

    <!-- Đánh giá sản phẩm -->
<div *ngIf="activeTab === 'reviews'">
  <div *ngIf="loadingReviews" class="loading-state">Đang tải đánh giá...</div>
  <div *ngIf="!loadingReviews && reviews.length === 0" class="empty-state">
    Chưa có đánh giá nào cho sản phẩm này. Hãy là người đầu tiên!
  </div>

  <div class="average-rating">
  <span class="avg-stars">
    {{ averageRating }}
    <i class="fa-solid fa-star filled-star"></i>
  </span>
  <span class="avg-text">/ 5</span>
  <span class="total-reviews">    ({{ reviews.length }} đánh giá)</span>
</div>
<div class="review-filter">
  <button
    class="filter-btn"
    [class.active]="selectedStar === null"
    (click)="filterByStar(null)"
  >
    Tất cả
  </button>

  <button
    *ngFor="let star of [5,4,3,2,1]"
    class="filter-btn"
    [class.active]="selectedStar === star"
    (click)="filterByStar(star)"
  >
    {{ star }}
    <i class="fa-solid fa-star"></i>
  </button>
</div>

  <div *ngIf="!loadingReviews && reviews.length > 0">
    
    <div *ngFor="let r of filteredReviews" class="review-item">
      <div class="review-header">
        <img
          *ngIf="r.user?.avatarUrl"
          [src]="r.user?.avatarUrl"
          alt="Avatar"
          class="review-avatar"
        />
        <div class="review-user-info">
          <p class="review-user">{{ r.user?.name || 'Người dùng Ẩn Danh' }}</p>
          <span *ngIf="r.isVerifiedBuyer" class="badge-verified">
            <i class="fa-solid fa-circle-check"></i> Đã mua hàng
          </span>
        </div>
      </div>

      <div class="review-rating-info">
        <p class="review-rating">
          <ng-container *ngFor="let star of [].constructor(r.rating)">
            <i class="fa-solid fa-star filled-star"></i>
          </ng-container>
          <ng-container *ngFor="let star of [].constructor(5 - r.rating)">
            <i class="fa-regular fa-star empty-star"></i>
          </ng-container>
        </p>
         <p class="review-date">{{ r.createdAt | date:'dd/MM/yyyy' }}</p>
      </div>
      
      <p class="review-variant" *ngIf="r.sizeName || r.colorName">
        Phân loại: <span *ngIf="r.sizeName">Size: {{ r.sizeName }}</span>
        <span *ngIf="r.colorName"> | Màu: {{ r.colorName }}</span>
      </p>

      <p class="review-comment">{{ r.comment }}</p>

      <div class="review-actions">
          <button 
              class="action-button helpful-button" 
              [class.is-clicked]="r.isClicked" 
              (click)="markHelpful(r._id)" 
              title="Đánh dấu là hữu ích"
          >
              <i class="fa-thumbs-up" 
                [class.fa-solid]="r.isClicked" 
                [class.fa-regular]="!r.isClicked"></i> 
              Hữu ích ({{ r.helpfulCount || 0 }})
          </button>
          
          <button class="action-button report-button">
            <i class="fa-solid fa-flag"></i> Báo cáo
          </button>
      </div>

      <hr class="review-separator"/>
    </div>
  </div>
</div>


<!-- <div *ngIf="activeTab === 'description' && product">
    <div class="product-description-content">
        <h3 class="description-title">Mô tả Sản phẩm</h3>
        <p [innerHTML]="product.description"></p>
    </div>
</div> -->

  </div>
</section>

  </div>
</div>
