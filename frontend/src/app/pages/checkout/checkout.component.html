<div class="checkout-container">
  <h1 class="page-title">Thanh toán</h1>

  <div class="checkout-content" *ngIf="!loading; else loadingTemplate">
    <!-- Cart Summary -->
    <div class="cart-summary" *ngIf="selectedItems.length > 0">
      <h3>Sản phẩm đã chọn</h3>
      <div *ngFor="let item of selectedItems" class="cart-item">
        <img [src]="item.image || 'assets/images/placeholder-shirt.png'" alt="{{ item.name }}" class="item-image">
        <div class="item-info">
          <p class="item-name">{{ item.name }}</p>
          <p class="item-variant" *ngIf="item.colorName || item.sizeName">
            {{ item.colorName || '' }}<span *ngIf="item.colorName && item.sizeName"> | </span>{{ item.sizeName || '' }}
          </p>
          <p class="item-quantity">Số lượng: {{ item.quantityToAdd || 1 }}</p>
        </div>
        <p class="item-price">{{ (item.price * (item.quantityToAdd || 1)) | currency : 'VND' }}</p>
      </div>
      <div class="summary-section">
        <div class="summary-row">
          <span>Tạm tính:</span>
          <span>{{ subtotal | currency : 'VND' }}</span>
        </div>
        <div class="summary-row">
          <span>Phí vận chuyển:</span>
          <span>{{ deliveryFee === 0 ? 'Free ship' : (deliveryFee | currency : 'VND') }}</span>
        </div>
        <div class="summary-row" *ngIf="voucherDiscount > 0">
        <span>Voucher giảm giá:</span>
        <span class="discount-amount">-{{ voucherDiscount | currency : 'VND' }}</span>
      </div>
        <div class="summary-row total-row">
          <strong>Tổng cộng:</strong>
          <strong>{{ totalAmount | currency : 'VND' }}</strong>
        </div>
      </div>
    </div>

    <!-- Checkout Form -->
    <form class="checkout-form" (ngSubmit)="handleCheckout()">
      <h3>Thông tin người nhận</h3>

      <!-- Chọn địa chỉ đã lưu -->
      <div class="address-section" *ngIf="addresses.length > 0">
        <div class="form-group">
          <label>Chọn địa chỉ đã lưu</label>
          <select 
            class="address-select"
            [(ngModel)]="selectedAddressId"
            name="selectedAddress"
            (change)="selectAddressFromId()"
            [disabled]="useNewAddress">
            <option [value]="null">-- Chọn địa chỉ --</option>
            <option *ngFor="let addr of addresses" [value]="addr._id">
              {{ addr.receiverName }} - {{ addr.street }}, {{ addr.ward }}, {{ addr.district }}, {{ addr.province }}{{ addr.isDefault ? ' (Mặc định)' : '' }}
            </option>
          </select>
        </div>

        <!-- Option nhập địa chỉ mới -->
        <div class="form-group">
          <div class="address-checkbox">
            <input 
              type="checkbox" 
              [(ngModel)]="useNewAddress"
              name="useNewAddress"
              (change)="useNewAddressToggle()"
              id="useNewAddress">
            <span>Nhập địa chỉ mới</span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="receiver_name">Họ và tên *</label>
        <input
          type="text"
          id="receiver_name"
          [(ngModel)]="receiver_name"
          name="receiver_name"
          [readonly]="!useNewAddress && selectedAddressId"
          [class.readonly-input]="!useNewAddress && selectedAddressId"
          required
          placeholder="Nhập họ và tên người nhận"
        />
      </div>

      <div class="form-group">
        <label for="receiver_mobile">Số điện thoại *</label>
        <input
          type="tel"
          id="receiver_mobile"
          [(ngModel)]="receiver_mobile"
          name="receiver_mobile"
          [readonly]="!useNewAddress && selectedAddressId"
          [class.readonly-input]="!useNewAddress && selectedAddressId"
          required
          placeholder="Nhập số điện thoại"
        />
      </div>

      <div class="form-group">
        <label for="receiver_address">Địa chỉ nhận hàng *</label>
        <textarea
          id="receiver_address"
          [(ngModel)]="receiver_address"
          name="receiver_address"
          [readonly]="!useNewAddress && selectedAddressId"
          [class.readonly-input]="!useNewAddress && selectedAddressId"
          required
          rows="3"
          placeholder="Nhập địa chỉ nhận hàng"
        ></textarea>
      </div>

      

      <div class="form-group voucher-group">
        <label for="voucher_code">Voucher</label>
        <div class="voucher-input-row" (click)="openVoucherModal()">
        <input
          type="text"
          id="voucher_code"
          [(ngModel)]="voucher_code"
          name="voucher_code"
            placeholder="Chọn hoặc nhập mã giảm giá"
          readonly
        />
          <button 
            type="button" 
            class="btn btn-secondary btn-select-voucher" 
            (click)="$event.stopPropagation(); openVoucherModal()">
            Chọn voucher
          </button>
          <button 
            *ngIf="voucher_code" 
            type="button" 
            class="btn-link clear-voucher" 
            (click)="$event.stopPropagation(); clearVoucher()">
            Xóa
          </button>
        </div>
        <p *ngIf="voucherDiscount > 0" class="voucher-note">
          Đã áp dụng voucher: {{ voucher_code }} (giảm {{ voucherDiscount | currency : 'VND' }})
        </p>
      </div>

      <div class="payment-method-section">
        <h3>Chọn phương thức thanh toán</h3>
        
        <div class="payment-options">
          <label>
            <input 
              type="radio" 
              name="paymentMethod" 
              value="VNPay" 
              [(ngModel)]="paymentMethod"
              checked>
            <span>Thanh toán VNPay</span>
            <i class="fa-solid fa-credit-card"></i>
          </label>
          
          <label>
            <input 
              type="radio" 
              name="paymentMethod" 
              value="COD" 
              [(ngModel)]="paymentMethod">
            <span>Thanh toán khi nhận hàng (COD)</span>
            <i class="fa-solid fa-money-bill-wave"></i>
          </label>
        </div>
      </div>

      <button type="submit" class="btn btn-primary checkout-btn" [disabled]="loading">
        <span *ngIf="loading">Đang xử lý...</span>
        <span *ngIf="!loading">Thanh toán</span>
      </button>
    </form>

   
  </div>

  <!-- Voucher modal -->
  <div class="voucher-modal-backdrop" *ngIf="isVoucherModalOpen">
    <div class="voucher-modal">
      <div class="voucher-modal-header">
        <h3>Chọn voucher của bạn</h3>
        <button type="button" class="close-btn" (click)="closeVoucherModal()">×</button>
      </div>

      <div class="voucher-modal-body">
        <p class="order-subtotal">
          Giá trị đơn hàng: <strong>{{ subtotal | currency : 'VND' }}</strong>
        </p>

        <div *ngIf="isLoadingVouchers" class="voucher-loading">
          Đang tải danh sách voucher...
        </div>

        <div *ngIf="voucherError" class="voucher-error">
          {{ voucherError }}
        </div>

        <div *ngIf="!isLoadingVouchers && !voucherError">
          <div *ngIf="myVouchers.length === 0" class="voucher-empty">
            Bạn chưa có voucher nào. Hãy thu thập voucher ở trang khuyến mãi nhé.
          </div>

          <div 
            *ngFor="let v of myVouchers" 
            class="voucher-item"
            [ngClass]="{ 'disabled': subtotal < v.min_order_value }"
          >
            <div class="voucher-info">
              <div class="voucher-code">{{ v.code }}</div>
              <div class="voucher-desc">
                <span *ngIf="v.type === 'percent'">Giảm {{ v.value }}%</span>
                <span *ngIf="v.type === 'fixed'">Giảm {{ v.value | currency : 'VND' }}</span>
                <span class="voucher-min">
                  Đơn tối thiểu: {{ v.min_order_value | currency : 'VND' }}
                </span>
              </div>
              <div class="voucher-date">
                Hạn dùng: {{ v.end_date | date:'dd/MM/yyyy' }}
              </div>
            </div>

            <div class="voucher-actions">
              <button
                type="button"
                class="btn btn-small"
                [disabled]="subtotal < v.min_order_value"
                (click)="applyVoucherFromModal(v)"
              >
                <span *ngIf="subtotal >= v.min_order_value">Áp dụng</span>
                <span *ngIf="subtotal < v.min_order_value">Chưa đủ điều kiện</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template #loadingTemplate>
    <div class="loading-message">
      <p>Đang tải thông tin...</p>
    </div>
  </ng-template>
</div>
