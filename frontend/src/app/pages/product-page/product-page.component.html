<section class="product-section">
  <div class="product-container">


    <!-- üîπ SIDEBAR FILTER (B√™n tr√°i) -->
    <aside class="filter-sidebar">

      <!-- Header Sidebar -->
      <div class="filter-header">
        <h2 class="filter-header-title">
          <i class="fa-solid fa-filter"></i>
          B·ªô l·ªçc
        </h2>
        <button class="btn-reset" (click)="resetFilters()">
          <i class="fa-solid fa-rotate-left"></i>
          X√≥a b·ªô l·ªçc
        </button>
      </div>
     <!-- 1. FILTER CATEGORY -->
      <div class="filter-group">
        <h3 class="filter-title">
          <i class="fa-solid fa-tags"></i>
          Danh m·ª•c
        </h3>
        <div class="filter-buttons">
          <button (click)="filterByCategory(null)" [class.active]="!filters.category" class="filter-btn">
            <i class="fa-solid fa-th"></i>
            T·∫•t c·∫£
          </button>
          <button *ngFor="let cat of categories" (click)="filterByCategory(cat.slug!)"
            [class.active]="filters.category === cat.slug" class="filter-btn">
            {{ cat.name }}
          </button>
        </div>
      </div>

      <!-- 2. FILTER SIZE -->
      <div class="filter-group">
        <h3 class="filter-title">
          <i class="fa-solid fa-ruler"></i>
          K√≠ch th∆∞·ªõc
        </h3>
        <div class="size-options">
          <label *ngFor="let size of availableSizes" class="size-checkbox"
            [class.checked]="filters.sizes.includes(size)">
            <input type="checkbox" [checked]="filters.sizes.includes(size)" (change)="toggleSize(size)">
            <span class="checkbox-custom"></span>
            <span class="size-label">{{ size }}</span>
          </label>
        </div>
      </div>

      <!-- 3. FILTER PRICE (Slider) -->
      <div class="filter-group">
        <h3 class="filter-title">
          <i class="fa-solid fa-dollar-sign"></i>
          CH·ªåN GI√Å
        </h3>
        <div class="price-slider">
          <!-- Input Min -->
          <div class="price-input-group">
            <label class="price-label">T·ª´</label>
            <input type="number" [(ngModel)]="filters.priceRange.min"
              (ngModelChange)="updatePriceRange(filters.priceRange.min, filters.priceRange.max)" class="price-input"
              [min]="20000" [max]="5000000">
            <span class="price-unit">‚Ç´</span>
          </div>

          <!-- Slider Container - 1 THANH C√ì 2 C·ª§C (MIN & MAX) -->
          <div class="slider-container">
            <input type="range" [min]="20000" [max]="5000000" [(ngModel)]="filters.priceRange.min"
              (input)="updatePriceRange(filters.priceRange.min, filters.priceRange.max)" class="slider slider-min">

            <input type="range" [min]="20000" [max]="5000000" [(ngModel)]="filters.priceRange.max"
              (input)="updatePriceRange(filters.priceRange.min, filters.priceRange.max)" class="slider slider-max">
          </div>

          <!-- Input Max -->
          <div class="price-input-group">
            <label class="price-label">ƒê·∫øn</label>
            <input type="number" [(ngModel)]="filters.priceRange.max"
              (ngModelChange)="updatePriceRange(filters.priceRange.min, filters.priceRange.max)" class="price-input"
              [min]="20000" [max]="5000000">
            <span class="price-unit">‚Ç´</span>
          </div>
        </div>

        <!-- Hi·ªÉn th·ªã gi√° ƒë√£ ch·ªçn -->
        <div class="price-display">
          <span class="price-display-label">Kho·∫£ng gi√°:</span>
          <span class="price-display-value">
            {{ filters.priceRange.min | number }} ‚Ç´ -
            {{ filters.priceRange.max | number }} ‚Ç´
          </span>
        </div>
      </div>

    </aside>

    <!-- üîπ PRODUCT CONTENT (B√™n ph·∫£i) -->
    <div class="product-content">

      <nav class="breadcrumb">
        <a routerLink="/home">Trang ch·ªß</a>
        <span>/</span>
        <a routerLink="/products">S·∫£n ph·∫©m</a>
      </nav>
      <!-- Header Product List -->
      <div class="product-header">
        <h2 class="product-header-title">
          S·∫£n ph·∫©m
          <span class="product-count" *ngIf="!loading">
            ({{ filteredProducts.length }} s·∫£n ph·∫©m)
          </span>
        </h2>
      </div>

      <!-- Loading -->
      <div *ngIf="loading" class="loading-container">
        <div class="loading-spinner"></div>
        <p class="loading-text">ƒêang t·∫£i s·∫£n ph·∫©m...</p>
      </div>

      <!-- Danh s√°ch s·∫£n ph·∫©m -->
      <div class="product-list" *ngIf="!loading && filteredProducts.length > 0">
        <div class="product-card" *ngFor="let product of filteredProducts">
          <!-- ·∫¢nh -->
          <div class="product-image">
            <img [src]="
                product.image && product.image.length
                  ? product.image[0]
                  : 'assets/images/placeholder.jpg'
              " [alt]="product.name" class="product-img" />
            <div class="product-overlay">
              <button class="btn-detail">
                <i class="fa-solid fa-eye"></i>
                <a [routerLink]="['/products', product.slug]">
                  Xem chi ti·∫øt
                </a>
              </button>
              <button class="btn-buy">
                <i class="fa-solid fa-cart-shopping"></i>
                Mua ngay
              </button>
            </div>
          </div>

          <!-- Th√¥ng tin -->
          <div class="product-info">
            <!-- T√äN S·∫¢N PH·∫®M -->
            <h3 class="product-name">{{ product.name }}</h3>

            <!-- GI√Å S·∫¢N PH·∫®M -->
            <p class="product-price">{{ product.price | number }} ‚Ç´</p>

            <!-- L∆Ø·ª¢T XEM -->
            <p class="product-views">
              <i class="fa fa-eye"></i> {{ product.viewCount || 0 }} l∆∞·ª£t xem
            </p>
          </div>

          <!-- N√∫t th√™m gi·ªè -->
          <div class="product-action">
            <button class="btn-cart" (click)="openVariantModal(product)">
              Th√™m v√†o gi·ªè h√†ng
            </button>
          </div>
        </div>
      </div>



      <!-- Empty State -->
      <div *ngIf="!loading && filteredProducts.length === 0" class="empty-container">
        <i class="fa-solid fa-box-open empty-icon"></i>
        <p class="empty-text">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.</p>
        <button class="btn-empty-reset" (click)="resetFilters()">
          X√≥a b·ªô l·ªçc
        </button>
      </div>

    </div>


    <div class="modal-overlay" *ngIf="isModalOpen && selectedProduct">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ch·ªçn Bi·∫øn th·ªÉ cho {{ selectedProduct.name }}</h2>
                <button class="close-btn" (click)="closeModal()">√ó</button>
            </div>

            <div class="modal-body">
                
                <div class="product-preview">
                    <img [src]="selectedProduct.image && selectedProduct.image.length ? selectedProduct.image[0] : 'assets/images/placeholder.jpg'" 
                            [alt]="selectedProduct.name" 
                            class="preview-img">
                    <div class="preview-info">
                        <p class="preview-price">{{ (currentVariantDetails?.price || selectedProduct.price) | number }} ‚Ç´</p>
                        <p class="preview-stock">T·ªìn kho: {{ currentVariantDetails?.quantity || 'H·∫øt' }}</p> 
                    </div>
                </div>

                <!-- Loading state -->
                <div *ngIf="isLoadingVariants" class="variant-loading">
                    <p>ƒêang t·∫£i th√¥ng tin bi·∫øn th·ªÉ...</p>
                </div>

                <!-- Error message khi kh√¥ng c√≥ variants -->
                <div *ngIf="!isLoadingVariants && variantErrorMessage" class="variant-error">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <p>{{ variantErrorMessage }}</p>
                    <p class="variant-hint">Vui l√≤ng li√™n h·ªá admin ƒë·ªÉ th√™m bi·∫øn th·ªÉ cho s·∫£n ph·∫©m n√†y.</p>
                </div>

                <!-- Variant selection khi c√≥ d·ªØ li·ªáu -->
                <div *ngIf="!isLoadingVariants && !variantErrorMessage">
                    <!-- Size selection -->
                    <div class="variant-selection">
                        <label>K√≠ch c·ª°:</label>
                        <div class="options-container">
                            <button *ngFor="let size of availableVariantSizes"
                                    [class.selected]="selectedSizeName === size.name"
                                    (click)="selectedSizeName = size.name; updateVariantDetails()"
                                    [disabled]="!size">
                                {{ size.name }}
                            </button>
                            <p *ngIf="availableVariantSizes.length === 0" class="no-options">
                                Ch∆∞a c√≥ k√≠ch c·ª° n√†o
                            </p>
                        </div>
                    </div>

                    <!-- Color selection -->
                    <div class="variant-selection">
                        <label>M√†u s·∫Øc:</label>
                        <div class="options-container color-options">
                            <button *ngFor="let color of availableColors"
                                    [class.selected]="selectedColorName === color.name"
                                    [style.backgroundColor]="color.hex || '#ccc'"
                                    [title]="color.name"
                                    (click)="selectedColorName = color.name; updateVariantDetails()">
                            </button>
                            <p *ngIf="availableColors.length === 0" class="no-options">
                                Ch∆∞a c√≥ m√†u s·∫Øc n√†o
                            </p>
                        </div>
                    </div>
                    
                    <!-- Quantity control - ch·ªâ hi·ªÉn th·ªã khi ƒë√£ ch·ªçn size v√† color -->
                    <div class="quantity-control" *ngIf="selectedSizeName && selectedColorName && currentVariantDetails">
                        <label>S·ªë l∆∞·ª£ng:</label>
                        <div class="quantity-input-group">
                            <button (click)="decrementQuantity()">-</button>
                            <input type="number" 
                                    [(ngModel)]="quantityToAdd" 
                                    [min]="1" 
                                    [max]="currentVariantDetails.quantity || 99" 
                                    (change)="onQuantityChange($event)"> 
                            <button (click)="incrementQuantity()">+</button>
                        </div>
                        <p class="quantity-hint">
                            T·ªëi ƒëa: {{ currentVariantDetails.quantity }} s·∫£n ph·∫©m
                        </p>
                    </div>

                    <!-- Th√¥ng b√°o khi ch∆∞a ch·ªçn ƒë·ªß size/color -->
                    <div *ngIf="(!selectedSizeName || !selectedColorName) && availableVariantSizes.length > 0 && availableColors.length > 0" 
                         class="variant-hint">
                        <p>Vui l√≤ng ch·ªçn k√≠ch c·ª° v√† m√†u s·∫Øc ƒë·ªÉ xem gi√° v√† t·ªìn kho.</p>
                    </div>
                </div>
            </div> 
            <div class="modal-footer">
                <button class="btn-cancel" (click)="closeModal()">H·ªßy</button>
                <button class="btn-confirm" 
                        [disabled]="isLoadingVariants || !!variantErrorMessage || !currentVariantDetails || quantityToAdd < 1 || (currentVariantDetails && quantityToAdd > currentVariantDetails.quantity)" 
                        (click)="confirmAddToCart()">
                    X√°c nh·∫≠n v√† Th√™m v√†o Gi·ªè
                </button>
            </div>
        </div>
    </div> <!-- ƒê√≥ng modal-overlay -->

  </div> <!-- ƒê√≥ng product-container -->
</section>