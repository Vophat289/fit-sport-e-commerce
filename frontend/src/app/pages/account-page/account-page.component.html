<div class="account-container">
  <div class="breadcrumb">TRANG CHỦ > MY ACCOUNT</div>

  <div class="header-and-avatar">
    <h2 class="account-title">Tài khoản của Tôi</h2>
    <div class="profile-header-right">
      <div class="avatar-wrapper">
        <img src="data:image/png;base64,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" alt="Ảnh đại diện" class="avatar-placeholder" />
      </div>
      <div class="profile-greeting">
        <h3>Xin chào, <span class="username" >Foden</span></h3>
        <div class="action-buttons">
          <button class="action-button">Chỉnh sửa ảnh</button>

          <!-- Sửa thông tin -->
          <button type="button" (click)="enterEditMode()" *ngIf="!isEditing">
            Sửa thông tin cá nhân
          </button>

          <!-- Lưu thông tin (nút ngoài form) -->
          <button type="button" class="save-button" *ngIf="isEditing"
            (click)="profileForm.form.valid && profileForm.ngSubmit.emit()">
            Lưu
          </button>

          <!-- Hủy chỉnh sửa -->
          <button type="button" (click)="cancelEdit()" *ngIf="isEditing">
            Hủy
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="account-main-content">
    <aside class="account-sidebar">
      <button class="sidebar-button button-main" [class.active]="currentTab === 'profile'"
        (click)="selectTab('profile')">
        Thông tin cá nhân
      </button>
      <button class="sidebar-button button-main" [class.active]="currentTab === 'orders'" (click)="selectTab('orders')">
        Đơn hàng của tôi
      </button>
      <button class="sidebar-button button-main" [class.active]="currentTab === 'vouchers'"
        (click)="selectTab('vouchers')">
        Vouchers của tôi
      </button>
      <button class="sidebar-button button-main" [class.active]="currentTab === 'address'"
        (click)="selectTab('address')">
        Địa chỉ của tôi
      </button>
      <button class="sidebar-button logout-button" (click)="logout()">
        Đăng xuất
      </button>
    </aside>

    <section class="account-details">
      <!-- Profile Tab -->
      <ng-container *ngIf="currentTab === 'profile'">
        <form (ngSubmit)="saveChanges()" #profileForm="ngForm" class="profile-form">
          <div class="info-row">
            <label>Họ tên:</label>
            <input type="text" [(ngModel)]="editData.name" name="name" [readonly]="!isEditing" required />
          </div>
          <div class="info-row">
            <label>Email:</label>
            <input type="email" [(ngModel)]="editData.email" name="email" [readonly]="!isEditing" required />
          </div>
          <div class="info-row">
            <label>Số điện thoại:</label>
            <input type="tel" [(ngModel)]="editData.phone" name="phone" [readonly]="!isEditing" />
          </div>
          <div class="info-row">
            <label>Ngày sinh:</label>
            <input type="date" [(ngModel)]="editData.dob" name="dob" [readonly]="!isEditing" />
          </div>
        </form>
      </ng-container>
      <!-- Orders Tab -->
      <ng-container *ngIf="currentTab === 'orders'">
        <div class="order-view-wrapper">
          <ng-container *ngIf="!selectedOrder">
            <h2 class="order-page-title">Đơn hàng của tôi</h2>
            <p class="order-summary">
              Đang hiển thị {{ getFilteredOrders().length }} /
              {{ getTotalFilteredOrdersCount() }} đơn hàng.
            </p>

            <div class="order-list-container">
              <ng-container *ngFor="let order of getFilteredOrders()">
                <div class="order-card">
                  <div class="order-image-column">
                    <img [src]="
                        order.first_item_image_url ||
                        'assets/images/default-product.png'
                      " alt="Sản phẩm" class="product-image" />
                  </div>

                  <div class="order-info">
                    <div class="order-header-info">
                      <p class="order-code-text">
                        <strong>Mã đơn:</strong> {{ order.order_code }}
                      </p>
                      <p class="order-date-text">
                        <strong>Ngày đặt:</strong>
                        {{ order.createdAt | date : "dd/MM/yyyy HH:mm" }}
                      </p>
                    </div>

                    <div class="order-detail-info">
                      <p class="first-item-name">
                        <strong>{{
                          order.first_item_name || "Đơn hàng gồm nhiều sản phẩm"
                          }}</strong>
                      </p>
                      <p>
                        <strong>Người nhận:</strong>
                        {{ order.receiver_name }} – {{ order.receiver_mobile }}
                      </p>
                      <p>
                        <strong>Địa chỉ:</strong> {{ order.receiver_address }}
                      </p>
                    </div>
                  </div>

                  <div class="order-actions">
                    <div class="order-total-price">
                      Tổng tiền:
                      <span class="total-amount">{{ order.total_price | number }}₫</span>
                    </div>

                    <button class="cancel-button-order" *ngIf="order.status.toUpperCase() === 'PENDING'"
                      (click)="cancelOrder(order._id!)">
                      Hủy đơn hàng
                    </button>

                    <button class="detail-button" (click)="viewOrderDetail(order._id!)">
                      Chi tiết
                    </button>

                    <span class="order-status" [ngClass]="'status-' + order.status.toLowerCase()">
                      {{ getOrderStatusText(order.status) }}
                    </span>
                  </div>
                </div>
              </ng-container>
            </div>

            <div class="load-more-orders-container" *ngIf="ordersLimit < getTotalFilteredOrdersCount()">
              <button class="load-more-orders-button" (click)="loadMoreOrders()">
                Xem thêm đơn hàng ({{
                getTotalFilteredOrdersCount() - ordersLimit
                }}
                còn lại)
              </button>
            </div>
          </ng-container>

          <hr class="section-separator" *ngIf="!selectedOrder && getTotalFilteredOrdersCount() > 0" />

          <ng-container *ngIf="selectedOrder">
            <div class="order-detail-container">
              <button class="back-button" (click)="backToOrderList()">
                ← Quay lại danh sách
              </button>

              <h2>Chi tiết đơn hàng #{{ selectedOrder.order_code }}</h2>

              <div class="detail-header-info">
                <div class="detail-receiver-info">
                  <h3 class="info-title">Thông tin người nhận</h3>
                  <p>
                    <strong>Người nhận:</strong>
                    {{ selectedOrder.receiver_name }} –
                    {{ selectedOrder.receiver_mobile }}
                  </p>
                  <p>
                    <strong>Địa chỉ:</strong>
                    {{ selectedOrder.receiver_address }}
                  </p>
                </div>

                <div class="detail-date-status-info">
                  <p class="order-date-time">
                    <strong>Ngày đặt:</strong>
                    {{ selectedOrder.createdAt | date : "dd/MM/yyyy HH:mm" }}
                  </p>
                  <p class="order-status-line">
                    <strong>Trạng thái:</strong>
                    <span class="order-status" [ngClass]="'status-' + selectedOrder.status.toLowerCase()">
                      {{ getOrderStatusText(selectedOrder.status) }}
                    </span>
                  </p>

                  <button class="cancel-button-order detail-cancel-btn"
                    *ngIf="selectedOrder.status.toUpperCase() === 'PENDING'" (click)="cancelOrder(selectedOrder._id!)">
                    Hủy đơn hàng
                  </button>
                </div>
              </div>
              <hr />

              <h3>Sản phẩm:</h3>
              <div class="order-items-detail">
                <div class="item-detail-card" *ngFor="let item of selectedOrderItems">
                  <img [src]="
                      item.productDetail?.image[0] ||
                      'assets/images/default-product.png'
                    " alt="Sản phẩm" class="item-image-detail" />

                  <div class="item-info-detail">
                    <p class="item-name">
                      <strong>{{
                        item.productDetail?.name || "Đang tải tên..."
                        }}</strong>
                    </p>
                    <p class="item-variant">
                      <strong>Size:</strong> {{ item.variant.size }} |
                      <strong>Màu:</strong> {{ item.variant.color }}
                    </p>
                    <p class="item-qty-price">
                      <strong>Số lượng:</strong> {{ item.quantity }} x
                      {{ item.price | number }}₫
                    </p>
                    <p class="item-subtotal">
                      <strong style="color: black">Thành tiền: </strong>
                      <strong>{{ item.quantity * item.price | number }}₫</strong>
                    </p>
                  </div>
                </div>
              </div>

              <hr />

              <div class="payment-summary">
                <div class="payment-actions">
                  <button class="action-button refund-button"
                    *ngIf="selectedOrder.status.toUpperCase() === 'DELIVERED' || selectedOrder.status.toUpperCase() === 'SHIPPED'"
                    (click)="requestRefund(selectedOrder._id!)">
                    Yêu cầu Trả hàng/Hoàn tiền
                  </button>

                  <button class="action-button reorder-button" (click)="reorder(selectedOrder._id!)">
                    Mua lại đơn hàng
                  </button>
                </div>

                <div class="payment-calculation">
                  <p>
                    <strong>Tổng tiền hàng:</strong>
                    {{ selectedOrder.total_price | number }}₫
                  </p>
                  <p>
                    <strong>Phí vận chuyển:</strong>
                    {{ selectedOrder.delivery_fee | number }}₫
                  </p>

                  <h3 class="final-total">
                    <strong>Tổng thanh toán:</strong>
                    {{
                    selectedOrder.total_price + selectedOrder.delivery_fee
                    | number
                    }}₫
                  </h3>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </ng-container>

      <!-- Vouchers Tab -->
      <ng-container *ngIf="currentTab === 'vouchers'">
        <h2 class="voucher-title">Vouchers của tôi</h2>

        <div *ngIf="vouchers && vouchers.length; else noVouchers">
          <div class="voucher-list">
            <div class="voucher-card" *ngFor="let v of vouchers">
              <p>
                <strong>{{ v.code }}</strong> - Giảm {{ v.discountValue }}₫
                cho đơn ≥ {{ v.minOrderValue }}₫
              </p>
              <p>Hạn sử dụng: {{ v.expiryDate }} | Trạng thái: {{ v.status }}</p>
              <p>{{ v.description }}</p>
            </div>
          </div>
        </div>

        <ng-template #noVouchers>
          <p class="text-gray-500">Chưa có voucher nào.</p>
        </ng-template>
      </ng-container>


      <!-- Address Tab -->
      <ng-container *ngIf="currentTab === 'address'">
        <div class="address-list">
          <div *ngFor="let address of addresses" class="address-card"
            [class.selected-address]="address._id === selectedAddressId" (click)="selectAddress(address._id!)">
            <div class="address-selection-radio">
              <span class="radio-outer" [class.checked]="address._id === selectedAddressId">
                <span class="radio-inner" *ngIf="address._id === selectedAddressId"></span>
              </span>
            </div>

            <div class="address-info-content">
              <p class="address-contact-line">
                <span class="address-name">{{ address.receiverName }}</span>
                |
                <span class="address-phone">{{ address.phone }}</span>
                <span *ngIf="address.isDefault" class="default-tag">
                  Mặc định</span>
              </p>
              <p class="address-detail">
                {{ address.street }}, {{ address.ward }},
                {{ address.district }}, {{ address.province }}
              </p>
            </div>

            <div class="address-actions">
              <button class="action-edit" (click)="
                  openEditAddressModal(address); $event.stopPropagation()
                ">
                Sửa
              </button>
              <button class="action-delete" *ngIf="!address.isDefault"
                (click)="deleteAddress(address._id!); $event.stopPropagation()">
                Xóa
              </button>
            </div>
          </div>
        </div>
        <button class="add-new-address-button" (click)="openAddAddressModal()">
          + Thêm địa chỉ mới
        </button>
      </ng-container>

      <!-- Address Modal -->
      <div class="address-modal-overlay" *ngIf="isAddressModalOpen">
        <div class="address-modal-content">
          <div class="modal-header">
            <h3>
              {{
              editingAddress && !editingAddress._id
              ? "Thêm địa chỉ mới"
              : "Sửa địa chỉ"
              }}
            </h3>
            <button class="close-modal-button" (click)="closeAddressModal()">
              ×
            </button>
          </div>

          <div class="modal-body" *ngIf="editingAddress">
            <form (ngSubmit)="saveAddress()" #addressForm="ngForm">
              <div class="form-row">
                <label>Tên người nhận</label>
                <input [(ngModel)]="editingAddress.receiverName" name="recipientName" required />
              </div>
              <div class="form-row">
                <label>Số điện thoại</label>
                <input type="tel" [(ngModel)]="editingAddress.phone" name="recipientPhone" required />
              </div>
              <div class="form-row">
                <label>Tỉnh/Thành phố</label>
                <input [(ngModel)]="editingAddress.province" name="addressProvince" required />
              </div>
              <div class="form-row">
                <label>Quận/Huyện</label>
                <input [(ngModel)]="editingAddress.district" name="addressDistrict" required />
              </div>
              <div class="form-row">
                <label>Phường/Xã</label>
                <input [(ngModel)]="editingAddress.ward" name="addressWard" required />
              </div>
              <div class="form-row address-detail-row">
                <label>Địa chỉ chi tiết</label>
                <textarea [(ngModel)]="editingAddress.street" name="addressStreet" rows="3" required></textarea>
              </div>
              <div class="form-row default-checkbox">
                <input type="checkbox" id="isDefault" [(ngModel)]="editingAddress.isDefault" name="isDefault" />
                <label for="isDefault">Đặt làm địa chỉ mặc định</label>
              </div>
              <div class="modal-actions">
                <button type="button" class="cancel-button" (click)="closeAddressModal()">
                  Hủy
                </button>
                <button type="submit" class="save-button" [disabled]="!addressForm.valid">
                  Lưu địa chỉ
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>