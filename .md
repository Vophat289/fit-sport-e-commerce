# ğŸ”„ Luá»“ng Thanh ToÃ¡n VNPay: Tá»« Giá» HÃ ng Äáº¿n Trang Chá»§

## ğŸ“‹ Tá»•ng Quan

TÃ i liá»‡u nÃ y mÃ´ táº£ chi tiáº¿t luá»“ng thanh toÃ¡n tá»« khi ngÆ°á»i dÃ¹ng checkout giá» hÃ ng Ä‘áº¿n khi redirect vá» trang chá»§ sau khi thanh toÃ¡n VNPay thÃ nh cÃ´ng.

---

## ğŸ¨ SÆ¡ Äá»“ Luá»“ng Thanh ToÃ¡n (Mermaid)

```mermaid
sequenceDiagram
    participant User as ğŸ‘¤ NgÆ°á»i DÃ¹ng
    participant FE as Frontend<br/>(Angular)
    participant BE as Backend<br/>(Node.js)
    participant VNPay as VNPay Gateway

    User->>FE: Click "Thanh ToÃ¡n"
    FE->>BE: POST /api/cart/checkout<br/>{receiver_name, payment_method: 'VNPAY'}
    
    Note over BE: checkout() â†’ checkoutVNPay()
    Note over BE: - Validate thÃ´ng tin<br/>- TÃ¬m cart<br/>- Validate tá»“n kho<br/>- TÃ­nh tá»•ng tiá»n<br/>- Update cart â†’ order (PENDING)
    
    BE->>BE: buildPayment(amount, orderId, ip)
    Note over BE: vnpay.service.js<br/>Táº¡o payment URL
    
    BE-->>FE: {success: true, paymentUrl: "..."}
    FE->>VNPay: window.location.href = paymentUrl
    Note over User,VNPay: User thanh toÃ¡n trÃªn VNPay
    
    VNPay->>BE: IPN Callback<br/>POST /api/vnpay/ipn<br/>(Background)
    Note over BE: ipn()<br/>- Verify chá»¯ kÃ½<br/>- Update DB: payment_status = SUCCESS
    
    VNPay->>BE: Return URL<br/>GET /api/payment-success/return<br/>(User Redirect)
    Note over BE: returnUrl()<br/>- Verify chá»¯ kÃ½<br/>- Update DB (náº¿u chÆ°a)<br/>- Redirect vá» FE
    
    BE->>FE: Redirect: /payment-success?success=true&code=00&orderId=...
    Note over FE: payment-success.component.ts<br/>ngOnInit()<br/>- Äá»c query params<br/>- Hiá»ƒn thá»‹ káº¿t quáº£<br/>- clearCartOnSuccess()<br/>- LÆ°u sessionStorage<br/>- startCountdown()
    
    Note over FE: Äáº¿m ngÆ°á»£c 5 giÃ¢y
    FE->>FE: goToHome()<br/>router.navigate(['/home'])
    FE->>User: Hiá»ƒn thá»‹ trang chá»§<br/>(+ popup tá»« sessionStorage)
```

---

## ğŸ“Š SÆ¡ Äá»“ Luá»“ng Chi Tiáº¿t (Text Diagram)

## ğŸ” Luá»“ng Chi Tiáº¿t (Tá»« HÃ m NÃ y Äáº¿n HÃ m NÃ y)

### **BÆ¯á»šC 1: Frontend - NgÆ°á»i DÃ¹ng Click Thanh ToÃ¡n**

**File:** `frontend/src/app/pages/checkout/checkout.component.ts`

**HÃ m:** `handleVNPayCheckout()` (dÃ²ng 347-378)

```typescript
handleVNPayCheckout() {
  // Gá»­i request Ä‘áº¿n backend
  this.http.post<any>('/api/cart/checkout', checkoutData).subscribe({
    next: (response) => {
      if(response.success && response.paymentUrl){
        // LÆ°u orderId vÃ o sessionStorage
        sessionStorage.setItem('pendingOrderId', response.orderId);
        // Redirect Ä‘áº¿n VNPay
        window.location.href = response.paymentUrl; // â† Chuyá»ƒn sang VNPay
      }
    }
  });
}
```

**Chá»©c nÄƒng:**
- Gá»­i thÃ´ng tin checkout (receiver_name, receiver_mobile, receiver_address, voucher_code, payment_method: 'VNPAY')
- Nháº­n `paymentUrl` tá»« backend
- Redirect ngÆ°á»i dÃ¹ng Ä‘áº¿n trang thanh toÃ¡n VNPay

---

### **BÆ¯á»šC 2: Backend - Xá»­ LÃ½ Checkout Request**

**File:** `backend/src/controllers/cart.controller.js`

**HÃ m:** `checkout()` (dÃ²ng 386-403)

```javascript
export const checkout = async (req, res) => {
  const { payment_method } = req.body;
  
  if(payment_method === 'COD'){
    return await checkoutCOD(req, res);
  }
  
  // Máº·c Ä‘á»‹nh lÃ  VNPay
  return await checkoutVNPay(req, res); // â† Gá»i hÃ m nÃ y
}
```

**Chá»©c nÄƒng:** Router function, phÃ¢n loáº¡i phÆ°Æ¡ng thá»©c thanh toÃ¡n

---

### **BÆ¯á»šC 3: Backend - Xá»­ LÃ½ Checkout VNPay**

**File:** `backend/src/controllers/cart.controller.js`

**HÃ m:** `checkoutVNPay()` (dÃ²ng 405-615)

**CÃ¡c bÆ°á»›c xá»­ lÃ½:**

1. **Validate thÃ´ng tin ngÆ°á»i nháº­n** (dÃ²ng 412-415)
   - Kiá»ƒm tra receiver_name, receiver_mobile, receiver_address

2. **TÃ¬m giá» hÃ ng** (dÃ²ng 418-425)
   ```javascript
   const cart = await Oders.findOne({
     user_id: userId,
     status: 'CART'
   });
   ```

3. **Láº¥y chi tiáº¿t giá» hÃ ng** (dÃ²ng 428-441)
   ```javascript
   const cartDetails = await OdersDetails.find({ order_id: cart._id})
   ```

4. **Validate tá»“n kho** (dÃ²ng 443-486)
   - Kiá»ƒm tra sá»‘ lÆ°á»£ng tá»“n kho cÃ²n Ä‘á»§ khÃ´ng

5. **TÃ­nh tá»•ng tiá»n** (dÃ²ng 488-530)
   - TÃ­nh totalPrice tá»« cartDetails
   - TÃ­nh deliveryFee (30,000Ä‘)
   - Xá»­ lÃ½ voucher (náº¿u cÃ³)
   - TÃ­nh finalAmount = totalPrice + deliveryFee - voucherDiscount

6. **Cáº­p nháº­t cart thÃ nh order** (dÃ²ng 532-558)
   ```javascript
   cart.status = 'PENDING';
   cart.payment_method = 'VNPAY';
   cart.payment_status = 'INIT';
   cart.receiver_name = receiver_name;
   cart.receiver_mobile = receiver_mobile;
   cart.receiver_address = receiver_address;
   cart.total_price = totalPrice;
   cart.delivery_fee = deliveryFee;
   cart.voucher_discount = voucherDiscount;
   await cart.save();
   ```

7. **Táº¡o VNPay transaction ID** (dÃ²ng 560-571)
   ```javascript
   const vnpayOrderId = cart.order_code;
   cart.vnpay_transaction_id = vnpayOrderId;
   cart.payment_status = 'PENDING';
   await cart.save();
   ```

8. **Táº¡o Payment URL** (dÃ²ng 573-594)
   ```javascript
   const clientIp = req.headers['x-forwarded-for'] || req.ip || '127.0.0.1';
   paymentUrl = buildPayment(finalAmount, vnpayOrderId, clientIp); // â† Gá»i service
   ```

9. **Tráº£ vá» response** (dÃ²ng 596-602)
   ```javascript
   return res.status(200).json({
     success: true,
     orderId: cart._id,
     orderCode: cart.order_code,
     paymentUrl: paymentUrl, // â† URL Ä‘á»ƒ redirect
     amount: finalAmount
   });
   ```

---

### **BÆ¯á»šC 4: Backend - Táº¡o VNPay Payment URL**

**File:** `backend/src/services/vnpay.service.js`

**HÃ m:** `buildPayment()` (dÃ²ng 21-63)

```javascript
export function buildPayment(amount, orderId, ipAddr = "127.0.0.1"){
  const paymentConfig = {
    vnp_Amount: amount, // VNPay sáº½ tá»± Ä‘á»™ng nhÃ¢n 100
    vnp_IpAddr: ipAddr,
    vnp_TxnRef: orderId, // MÃ£ Ä‘Æ¡n hÃ ng
    vnp_OrderInfo: `Order #${orderId}`,
    vnp_ReturnUrl: config.returnUrl, // URL Ä‘á»ƒ VNPay redirect vá» sau thanh toÃ¡n
  };
  
  const paymentUrl = vnpay.buildPaymentUrl(paymentConfig);
  return paymentUrl; // â† Tráº£ vá» URL thanh toÃ¡n VNPay
}
```

**Chá»©c nÄƒng:**
- Táº¡o payment URL tá»« thÆ° viá»‡n VNPay
- Cáº¥u hÃ¬nh returnUrl (VNPay sáº½ redirect vá» URL nÃ y sau khi thanh toÃ¡n)

---

### **BÆ¯á»šC 5: NgÆ°á»i DÃ¹ng Thanh ToÃ¡n TrÃªn VNPay**

- NgÆ°á»i dÃ¹ng Ä‘Æ°á»£c redirect Ä‘áº¿n trang VNPay
- Nháº­p thÃ´ng tin tháº»/ngÃ¢n hÃ ng
- XÃ¡c nháº­n thanh toÃ¡n
- VNPay xá»­ lÃ½ giao dá»‹ch

---

### **BÆ¯á»šC 6: VNPay Callback - IPN (Instant Payment Notification)**

**File:** `backend/src/controllers/vnpay.controller.js`

**HÃ m:** `ipn()` (dÃ²ng 39-90)

**Route:** `POST /api/vnpay/ipn`

```javascript
export async function ipn(req, res){
  // Verify chá»¯ kÃ½ tá»« VNPay
  const result = verifyIpn(req.query);
  
  if(!result.isVerified){
    return res.json({ RspCode: "97", Message: "Checksum failed"});
  }
  
  // Láº¥y thÃ´ng tin tá»« VNPay
  const vnp_TxnRef = req.query.vnp_TxnRef; 
  const vnp_ResponseCode = req.query.vnp_ResponseCode;
  const vnp_TransactionStatus = req.query.vnp_TransactionStatus;
  
  // TÃ¬m order
  const order = await Oders.findOne({
    vnpay_transaction_id: vnp_TxnRef
  });
  
  // Cáº­p nháº­t tráº¡ng thÃ¡i
  if(vnp_ResponseCode === "00" && vnp_TransactionStatus === "00"){
    order.payment_status = 'SUCCESS';
    order.status = 'PENDING';
    await order.save();
    return res.json({ RspCode: "00", Message: "Thanh toÃ¡n thÃ nh cÃ´ng"});
  } else {
    // HoÃ n láº¡i tá»“n kho náº¿u tháº¥t báº¡i
    await restoreCartAfterPaymentFailed(order._id);
    order.payment_status = 'FAILED';
    order.status = 'CART';
    await order.save();
    return res.json({ RspCode: "07", Message: "Giao dá»‹ch khÃ´ng thÃ nh cÃ´ng"});
  }
}
```

**Chá»©c nÄƒng:**
- VNPay gá»­i callback Ä‘áº¿n server (background process)
- XÃ¡c thá»±c chá»¯ kÃ½
- Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng trong database

---

### **BÆ¯á»šC 7: VNPay Redirect - Return URL**

**File:** `backend/src/controllers/vnpay.controller.js`

**HÃ m:** `returnUrl()` (dÃ²ng 93-176)

**Route:** `GET /api/payment-success/return`

```javascript
export async function returnUrl(req, res){
  // Verify láº¡i chá»¯ kÃ½
  const result = verifyIpn(req.query);
  
  if(!result.isVerified){
    const frontendUrl = process.env.FRONTEND_URL || 'https://fitsport.io.vn';
    return res.redirect(`${frontendUrl}/payment-success?success=false&code=97`);
  }
  
  // TÃ¬m order
  const order = await Oders.findOne({
    vnpay_transaction_id: vnp_TxnRef
  });
  
  const frontendUrl = process.env.FRONTEND_URL || 'https://fitsport.io.vn';
  
  if(vnp_ResponseCode === "00" && vnp_TransactionStatus === "00"){
    // Thanh toÃ¡n thÃ nh cÃ´ng
    if(order.payment_status !== 'SUCCESS'){
      order.payment_status = 'SUCCESS';
      order.status = 'PENDING';
      await order.save();
    }
    
    // Redirect vá» frontend
    const redirectUrl = `${frontendUrl}/payment-success?success=true&code=00&orderId=${order._id}&orderCode=${order.order_code}`;
    return res.redirect(redirectUrl); // â† Redirect vá» frontend
  } else {
    // Thanh toÃ¡n tháº¥t báº¡i
    if(order.payment_status !== 'FAILED'){
      await restoreCartAfterPaymentFailed(order._id);
      order.payment_status = 'FAILED';
      order.status = 'CART';
      await order.save();
    }
    
    const redirectUrl = `${frontendUrl}/payment-success?success=false&code=${vnp_ResponseCode}`;
    return res.redirect(redirectUrl); // â† Redirect vá» frontend
  }
}
```

**Chá»©c nÄƒng:**
- VNPay redirect ngÆ°á»i dÃ¹ng vá» URL nÃ y sau khi thanh toÃ¡n
- XÃ¡c thá»±c láº¡i chá»¯ kÃ½
- Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng (náº¿u chÆ°a Ä‘Æ°á»£c IPN cáº­p nháº­t)
- Redirect ngÆ°á»i dÃ¹ng vá» trang payment-success cá»§a frontend

---

### **BÆ¯á»šC 8: Frontend - Hiá»ƒn Thá»‹ Káº¿t Quáº£ Thanh ToÃ¡n**

**File:** `frontend/src/app/pages/payment-success/payment-success.component.ts`

**HÃ m:** `ngOnInit()` (dÃ²ng 28-71)

```typescript
ngOnInit(){
  this.route.queryParams.subscribe(params => {
    // Äá»c thÃ´ng tin tá»« URL params
    this.responseCode = params['code'] || params['vnp_ResponseCode'] || '';
    this.orderId = params['orderId'] || '';
    this.orderCode = params['orderCode'] || '';
    
    // Kiá»ƒm tra káº¿t quáº£
    this.success = params['success'] === 'true' || this.responseCode === '00';
    
    if(this.success){
      this.message = 'Thanh toÃ¡n thÃ nh cÃ´ng!';
      this.clearCartOnSuccess(); // XÃ³a giá» hÃ ng
    } else {
      this.message = 'Thanh toÃ¡n tháº¥t báº¡i!';
    }
    
    // LÆ°u vÃ o sessionStorage Ä‘á»ƒ hiá»ƒn thá»‹ popup trÃªn trang chá»§
    sessionStorage.setItem('paymentResult', JSON.stringify({
      success: this.success,
      responseCode: this.responseCode,
      orderId: this.orderId,
      orderCode: this.orderCode,
      message: this.message
    }));
    
    // Báº¯t Ä‘áº§u Ä‘áº¿m ngÆ°á»£c 5 giÃ¢y
    this.startCountdown(); // â† Tá»± Ä‘á»™ng redirect sau 5 giÃ¢y
  });
}
```

**HÃ m:** `startCountdown()` (dÃ²ng 79-86)

```typescript
startCountdown() {
  this.countdownInterval = setInterval(() => {
    this.countdown--; // Giáº£m tá»« 5 xuá»‘ng 0
    if (this.countdown <= 0) {
      this.goToHome(); // â† Redirect vá» trang chá»§
    }
  }, 1000);
}
```

**HÃ m:** `goToHome()` (dÃ²ng 95-100)

```typescript
goToHome() {
  if (this.countdownInterval) {
    clearInterval(this.countdownInterval);
  }
  this.router.navigate(['/home']); // â† Navigate vá» trang chá»§
}
```

**Chá»©c nÄƒng:**
- Äá»c thÃ´ng tin tá»« URL params
- Hiá»ƒn thá»‹ káº¿t quáº£ thanh toÃ¡n
- XÃ³a giá» hÃ ng náº¿u thanh toÃ¡n thÃ nh cÃ´ng
- LÆ°u káº¿t quáº£ vÃ o sessionStorage
- Tá»± Ä‘á»™ng redirect vá» trang chá»§ sau 5 giÃ¢y (hoáº·c khi user click)

---

## ğŸ“Š SÆ¡ Äá»“ Luá»“ng Thanh ToÃ¡n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND (Angular)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[1] User Click "Thanh ToÃ¡n"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ checkout.component.ts                â”‚
â”‚ handleVNPayCheckout()                â”‚
â”‚ POST /api/cart/checkout              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Request: {receiver_name, receiver_mobile, 
               â”‚          receiver_address, voucher_code, 
               â”‚          payment_method: 'VNPAY'}
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND (Node.js/Express)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[2] cart.controller.js
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ checkout()                           â”‚
â”‚ â†’ checkoutVNPay()                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ checkoutVNPay()                      â”‚
â”‚ - Validate thÃ´ng tin                 â”‚
â”‚ - TÃ¬m cart                           â”‚
â”‚ - Validate tá»“n kho                   â”‚
â”‚ - TÃ­nh tá»•ng tiá»n                     â”‚
â”‚ - Update cart â†’ order (PENDING)      â”‚
â”‚ - buildPayment()                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ vnpay.service.js                      â”‚
â”‚ buildPayment(amount, orderId, ip)    â”‚
â”‚ â†’ vnpay.buildPaymentUrl()            â”‚
â”‚ â†’ return paymentUrl                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Response: {success: true, paymentUrl: "..."}
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ checkout.component.ts                â”‚
â”‚ window.location.href = paymentUrl    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Redirect to VNPay
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         VNPay Gateway                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[3] User thanh toÃ¡n trÃªn VNPay
    â”‚
    â”‚ (Sau khi thanh toÃ¡n)
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                 â”‚
    â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IPN Callback      â”‚        â”‚ Return URL       â”‚
â”‚ (Background)      â”‚        â”‚ (User Redirect)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â”‚ POST /api/vnpay/ipn       â”‚ GET /api/payment-success/return
         â”‚                           â”‚
         â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ vnpay.controller â”‚        â”‚ vnpay.controller â”‚
â”‚ ipn()             â”‚        â”‚ returnUrl()      â”‚
â”‚                   â”‚        â”‚                  â”‚
â”‚ - Verify chá»¯ kÃ½   â”‚        â”‚ - Verify chá»¯ kÃ½  â”‚
â”‚ - Update DB       â”‚        â”‚ - Update DB      â”‚
â”‚   payment_status   â”‚        â”‚   (náº¿u chÆ°a)     â”‚
â”‚   = SUCCESS        â”‚        â”‚ - Redirect vá» FE â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ Redirect: 
                                      â”‚ /payment-success?success=true&
                                      â”‚ code=00&orderId=...&orderCode=...
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND (Angular)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[4] payment-success.component.ts
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ngOnInit()                           â”‚
â”‚ - Äá»c query params                   â”‚
â”‚ - Hiá»ƒn thá»‹ káº¿t quáº£                    â”‚
â”‚ - clearCartOnSuccess()               â”‚
â”‚ - LÆ°u vÃ o sessionStorage             â”‚
â”‚ - startCountdown()                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Äáº¿m ngÆ°á»£c 5 giÃ¢y
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ goToHome()                           â”‚
â”‚ router.navigate(['/home'])           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         TRANG CHá»¦ (/home)            â”‚
â”‚  (Hiá»ƒn thá»‹ popup tá»« sessionStorage)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ CÃ¡c HÃ m ChÃ­nh

### **Frontend:**

1. **`checkout.component.ts::handleVNPayCheckout()`**
   - Gá»­i request checkout Ä‘áº¿n backend
   - Redirect Ä‘áº¿n VNPay

2. **`payment-success.component.ts::ngOnInit()`**
   - Xá»­ lÃ½ káº¿t quáº£ thanh toÃ¡n
   - LÆ°u vÃ o sessionStorage

3. **`payment-success.component.ts::goToHome()`**
   - Navigate vá» trang chá»§

### **Backend:**

1. **`cart.controller.js::checkout()`**
   - Router function, phÃ¢n loáº¡i payment method

2. **`cart.controller.js::checkoutVNPay()`**
   - Xá»­ lÃ½ logic checkout VNPay
   - Táº¡o order, tÃ­nh tiá»n, gá»i buildPayment

3. **`vnpay.service.js::buildPayment()`**
   - Táº¡o VNPay payment URL

4. **`vnpay.controller.js::ipn()`**
   - Xá»­ lÃ½ IPN callback tá»« VNPay (background)

5. **`vnpay.controller.js::returnUrl()`**
   - Xá»­ lÃ½ return URL khi user redirect vá»
   - Redirect vá» frontend payment-success page

---

## ğŸ“ LÆ°u Ã Quan Trá»ng

1. **Tá»“n kho Ä‘Æ°á»£c reserve khi thÃªm vÃ o giá» hÃ ng**
   - Khi thÃªm vÃ o cart â†’ giáº£m tá»“n kho
   - Khi thanh toÃ¡n tháº¥t báº¡i â†’ hoÃ n láº¡i tá»“n kho

2. **CÃ³ 2 callback tá»« VNPay:**
   - **IPN (Instant Payment Notification)**: Background callback, VNPay gá»­i Ä‘áº¿n server
   - **Return URL**: User redirect vá» sau khi thanh toÃ¡n

3. **Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng:**
   - `CART` â†’ `PENDING` (khi checkout)
   - `PENDING` + `payment_status: INIT` â†’ `PENDING` + `payment_status: PENDING` (khi táº¡o VNPay URL)
   - `PENDING` + `payment_status: SUCCESS` (khi thanh toÃ¡n thÃ nh cÃ´ng)
   - `CART` + `payment_status: FAILED` (khi thanh toÃ¡n tháº¥t báº¡i)

4. **SessionStorage Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ:**
   - LÆ°u `pendingOrderId` trÆ°á»›c khi thanh toÃ¡n
   - LÆ°u `paymentResult` sau khi thanh toÃ¡n (Ä‘á»ƒ hiá»ƒn thá»‹ popup trÃªn trang chá»§)

---

## ğŸ¯ TÃ³m Táº¯t Luá»“ng

```
User Click Checkout 
  â†’ Frontend: handleVNPayCheckout() 
  â†’ Backend: checkout() â†’ checkoutVNPay() 
  â†’ Backend: buildPayment() 
  â†’ Frontend: Redirect to VNPay 
  â†’ User thanh toÃ¡n trÃªn VNPay 
  â†’ VNPay: IPN callback (background) 
  â†’ VNPay: Return URL redirect 
  â†’ Backend: returnUrl() 
  â†’ Frontend: payment-success component 
  â†’ Frontend: goToHome() 
  â†’ Trang chá»§ (/home)
```

